var ext=1,img;
1==ext?img={load:chrome.extension.getURL("img/loader.gif"),fof:chrome.extension.getURL("img/404.png"),rprt:chrome.extension.getURL("img/report.png"),close:chrome.extension.getURL("img/x.png"),replyicon:chrome.extension.getURL("img/quickrep.png"),logo:chrome.extension.getURL("icon-48.png"),min:chrome.extension.getURL("img/min.png"),exp:chrome.extension.getURL("img/expand.png"),refreshBtn:chrome.extension.getURL("img/refresh.png"),favs:chrome.extension.getURL("img/bookmarks.png"),star:chrome.extension.getURL("img/star.png"),playbut:chrome.extension.getURL("img/play.png"),
awwyeah:chrome.extension.getURL("img/awwyeah.png")}:2==ext&&(img={load:safari.extension.baseURI+"img/loader.gif",fof:safari.extension.baseURI+"img/404.png",rprt:safari.extension.baseURI+"img/report.png",close:safari.extension.baseURI+"img/x.png",replyicon:safari.extension.baseURI+"img/quickrep.png",logo:safari.extension.baseURI+"icon-48.png",min:safari.extension.baseURI+"img/min.png",exp:safari.extension.baseURI+"img/expand.png",refreshBtn:safari.extension.baseURI+"img/refresh.png",favs:safari.extension.baseURI+
"img/bookmarks.png",star:safari.extension.baseURI+"img/star.png",playbut:safari.extension.baseURI+"img/play.png"});
var links=/((?:https?|ftp):\/\/[^\s'"'<>()]+|www\.[^\s'"'<>()]+|[\-\w.+]+@(?:[\-\w]+\.)+[\w]{2,6})/gi,title,showpopup,showquickreply,hiddenThreads,dblclick,files={},backlinks={},recapreload,reloadcheck,resetMessage,totalImg=15,resto,dragging,curquote,autodown,autoexpand,threadposts,images=[0,0],refresher,refreshrate,speedyrefresh,windowfocus=!0,unread=0,curextquote,frames,cooldowncount,cooldown,iframes=[],boardMenu='<div class="column"><h3>Japanese Culture</h3><ul><li><a href="/a/" class="boardlink" title="Anime &amp; Manga">Anime &amp; Manga</a></li><li><a href="/c/" class="boardlink" title="Anime/Cute">Anime/Cute</a></li><li><a href="/w/" class="boardlink" title="Anime/Wallpapers">Anime/Wallpapers</a></li><li><a href="/m/" class="boardlink" title="Mecha">Mecha</a></li><li><a href="/cgl/" class="boardlink" title="Cosplay &amp; EGL">Cosplay &amp; EGL</a></li><li><a href="/cm/" class="boardlink" title="Cute/Male">Cute/Male</a></li><li><a href="/f/" class="boardlink" title="Flash">Flash</a></li><li><a href="/n/" class="boardlink" title="Transportation">Transportation</a></li><li><a href="/jp/" class="boardlink" title="Otaku Culture">Otaku Culture</a></li><li><a href="/vp/" class="boardlink" title="Pok\u00e9mon">Pok\u00e9mon</a></li></ul></div><div class="column"><h3>Interests</h3><ul><li><a href="/v/" class="boardlink" title="Video Games">Video Games</a></li><li><a href="/vg/" class="boardlink" title="Video Games Generals">Video Game Generals</a></li><li><a href="/co/" class="boardlink" title="Comics &amp; Cartoons">Comics &amp; Cartoons</a></li><li><a href="/g/" class="boardlink" title="Technology">Technology</a></li><li><a href="/tv/" class="boardlink" title="Television &amp; Film">Television &amp; Film</a></li><li><a href="/k/" class="boardlink" title="Weapons">Weapons</a></li><li><a href="/o/" class="boardlink" title="Auto">Auto</a></li><li><a href="/an/" class="boardlink" title="Animals &amp; Nature">Animals &amp; Nature</a></li><li><a href="/tg/" class="boardlink" title="Traditional Games">Traditional Games</a></li><li><a href="/sp/" class="boardlink" title="Sports">Sports</a></li><li><a href="/sci/" class="boardlink" title="Science &amp; Math">Science &amp; Math</a></li><li><a href="/int/" class="boardlink" title="International">International</a></li></ul></div><div class="column"><h3>Creative</h3><ul><li><a href="/i/" class="boardlink" title="Oekaki">Oekaki</a></li><li><a href="/po/" class="boardlink" title="Papercraft &amp; Origami">Papercraft &amp; Origami</a></li><li><a href="/p/" class="boardlink" title="Photography">Photography</a></li><li><a href="/ck/" class="boardlink" title="Food &amp; Cooking">Food &amp; Cooking</a></li><li><a href="/ic/" class="boardlink" title="Artwork/Critique">Artwork/Critique</a></li><li><a href="/wg/" class="boardlink" title="Wallpapers/General">Wallpapers/General</a></li><li><a href="/mu/" class="boardlink" title="Music">Music</a></li><li><a href="/fa/" class="boardlink" title="Fashion">Fashion</a></li><li><a href="/toy/" class="boardlink" title="Toys">Toys</a></li><li><a href="/3/" class="boardlink" title="3DCG">3DCG</a></li><li><a href="/diy/" class="boardlink" title="Do-It-Yourself">Do-It-Yourself</a></li></ul></div><div class="column"><h3>Adult <span class="warning"></span></h3><ul><li><a href="/s/" class="boardlink" title="Sexy Beautiful Women">Sexy Beautiful Women</a></li><li><a href="/hc/" class="boardlink" title="Hardcore">Hardcore</a></li><li><a href="/hm/" class="boardlink" title="Hardcore Men">Hardcore Men</a></li><li><a href="/h/" class="boardlink" title="Hentai">Hentai</a></li><li><a href="/e/" class="boardlink" title="Ecchi">Ecchi</a></li><li><a href="/u/" class="boardlink" title="Yuri">Yuri</a></li><li><a href="/d/" class="boardlink" title="Hentai/Alternative">Hentai/Alternative</a></li><li><a href="/y/" class="boardlink" title="Yaoi">Yaoi</a></li><li><a href="/t/" class="boardlink" title="Torrents">Torrents</a></li><li><a href="http://rs.4chan.org/" class="boardlink" title="Rapidshares">Rapidshares</a></li><li><a href="/hr/" class="boardlink" title="High Resolution">High Resolution</a></li><li><a href="/gif/" class="boardlink" title="Animated GIF">Animated GIF</a></li></ul></div><div class="column"><h3>Other</h3><ul><li><a href="/trv/" class="boardlink" title="Travel">Travel</a></li><li><a href="/fit/" class="boardlink" title="Health &amp; Fitness">Health &amp; Fitness</a></li><li><a href="/x/" class="boardlink" title="Paranormal">Paranormal</a></li><li><a href="/lit/" class="boardlink" title="Literature">Literature</a></li><li><a href="/adv/" class="boardlink" title="Advice">Advice</a></li><li><a href="/mlp/" class="boardlink" title="Pony">Pony</a></li></ul><h3>Misc. <span class="warning"></span></h3><ul><li><a href="/b/" class="boardlink" title="Random">Random</a></li><li><a href="/r/" class="boardlink" title="Request">Request</a></li><li><a href="/r9k/" class="boardlink" title="Social">ROBOT9001</a></li><li><a href="/pol/" class="boardlink" title="Social">Politically incorrect</a></li><li><a href="/soc/" class="boardlink" title="Social">Social</a></li></ul></div><br class="clear-bug">';
window.top===window||1==ext?(1==ext?chrome.extension.onRequest.addListener(function(a){extensionResponses(a.response)}):2==ext&&safari.self.addEventListener("message",extensionResponses,!1),1==ext?settings?applyFeatures():(window.settings,window.board=!1,window.inThread=!1,window.protocol=document.location.protocol,chrome.extension.sendRequest({getOptions:!0},extensionResponses)):2==ext&&safari.self.tab.dispatchMessage("getSettings")):window.location.href.match(/(sys.4chan.org\/\w+\/post|banned)/)&&
2==ext&&safari.self.tab.dispatchMessage("posted",{response:document.body.innerHTML});
function extensionResponses(a){if(window.top==window||ext==1){a.name=="newposts"&&findNewPosts(a.message.message);a.name=="expansion"&&expandThread(a.message.action,a.message.message);a.name=="extquote"&&externalQuote(a.message.action,a.message.message);if(a.name=="settings"){settings=a.message;var b=window.location.href.match(/4chan\.org\/(\w+)\/?/);b&&(board=b[1]);board&&(inThread=window.location.href.match(/res\/([0-9]+)/));window.protocol=document.location.protocol;applyFeatures()}a.name==="postResult"&&
processPostResponse(a.message)}}
function processPostResponse(a){$("#message").hide();$("#progress").hide().removeAttr("value");$("#fileupload").show();var b=a.match(/Error: [^<]+/gi),d=a.match(/You are banned/gi);if(b){$("#response").html(b[0]).show();$("#clone_recaptcha_response_field").val("").focus()}else if(d)$("#response").html("You are banned!").show();else if(a.match(/successful/gi)){$("#submitbutton").attr("disabled",true).val("Cooldown: 30");cooldown=29;cooldowncount=setInterval(function(){cooldown--;if(cooldown==0){$("#submitbutton").removeAttr("disabled").val("Submit");
clearInterval(cooldowncount)}else $("#submitbutton").val("Cooldown: "+cooldown)},1E3);$("#clone_postFile").replaceWith("<input id='clone_postFile' name='upfile' type='file' />");document.getElementById("postform").com.value="";document.forms.post.elements.com.value="";$("#clone_recaptcha_response_field").val("");if(inThread){hideQuickreply();speedyrefresh=true;setTimeout(function(){speedyrefresh=false},5E4);refreshThread()}else{hideQuickreply();threadno=a.match(/thread:[0-9]+,no:([0-9]+)/);if(resto){a=
"res/"+resto+"#p"+threadno[1];resto=false}else a="res/"+threadno[1];window.location=protocol+"//boards.4chan.org/"+board+"/"+a}}else{$("#response").html("Error: Something wen't wrong").show();console.log("response"+a)}clearInterval(resetMessage);resetMessage=setTimeout(function(){$("#response").hide()},5E3)}
function applyFeatures(){if(!window.location.href.match(/boards\./)||board=="f")return false;var a=document.getElementsByTagName("iframe"),b=document.getElementsByTagName("embed");if(a.length>0){for(i=0;i<a.length;i++)if(a[i].src!="about:blank"){iframes.push([a[i],a[i].src]);if(settings.autoblock!="off"){a[i].src="";a[i].style.display="none"}}for(i=0;i<b.length;i++){iframes.push([b[i],b[i].src]);if(settings.autoblock!="off"){b[i].src="";b[i].style.display="none"}}if(iframes.length>0){a=document.createElement("div");
a.setAttribute("class","musicDetection reply");a.innerHTML="<h3>Media detected!</h3><input type='checkbox' id='mediatoggle' "+(settings.autoblock!="off"?"checked='true' ":"")+"/><label for='mediatoggle'>Disable media</label>";document.body.appendChild(a);$("#mediatoggle").click(function(){if($(this).is(":checked")){for(i=0;i<iframes.length;i++){iframes[i][0].src="";iframes[i][0].style.display="none"}chrome.extension.sendRequest({field:"autoblock",setValue:"on"})}else{for(i=0;i<iframes.length;i++){iframes[i][0].src=
iframes[i][1];iframes[i][0].style.display="block"}chrome.extension.sendRequest({field:"autoblock",setValue:"off"})}})}}a=settings.refreshinterval;refreshrate=a==0?1E3:a==2?Math.max(settings.customrefresh,100):3E3;if(settings.version&&settings.version<255){a=document.createElement("div");a.id="changelog";a.setAttribute("class","reply");a.setAttribute("style","border-width: 1px !important; background-image: none; background-repeat: no-repeat; background-position: right center");a.innerHTML="<div class='closeb' style='margin: 1px 2px'><img src='"+
img.close+"' /></div><div class='changelog'><img src='"+img.logo+"' /> 4chan Plus updated to v2.5.5!</div><div class='newf'><br /><strong>New features</strong><br /><p><\!-- - Thread/post hiding<br /> --\><\!-- - Lurk/fap mode--\>- :stopmusic:<br /><\!-- - Hide original post/reply box<br />--\><\!-- - Quick report <span style='text-size: 10px'>(off by default)</span><br />--\><\!-- - Settings accessible from top/bottom right<br />--\><\!-- - Change behaviour of reply button<br />--\><br /><span style='color: red'>Thread / post hiding coming soon!</span></p><br /><strong>Patches</strong><br /><p>- Backlinks update for new posts<br />- Incorrect backlink destination<br />- YouTube overlapping images / smartbar<br />- Original reply box filling up /w quotes<br />- File deletion killing expand all<br />- Post preview showing on images<br />- Image expansion on /s<br />- Buggy expand to max size<br />- Minor bugs</p><div class='newf'><br /><strong>Support 4chan Plus</strong><p><p><a href='https://chrome.google.com/webstore/detail/pinelipedelckihohgdlpcclgocodhjj' style='color: #9E2D00'>Rate</a> or <a href='https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=zoomify4chan%40gmail%2ecom&lc=US&item_name=4chan%20Plus&currency_code=USD&bn=PP%2dDonationsBF%3abtn_donateCC_LG%2egif%3aNonHosted' target='_blank' style='color: #9E2D00'>donate</a>!<br /><div class='newf'><p><br /><a href='"+
(ext==1?chrome.extension.getURL("options.html"):safari.extension.baseURI+"options.html")+"#feedback' target='_blank' style='color: #9E2D00; margin-right: 10px'>[Feedback]</a> <a href='"+(ext==1?chrome.extension.getURL("options.html"):safari.extension.baseURI+"options.html")+"' style='color: #9E2D00; float: right'>[Options]</a></div>";document.body.appendChild(a);if(settings.version<254)window.location='javascript:config.ss("4chan_enable_backlinking",false)';ext==1?chrome.extension.sendRequest({field:"version",
setValue:255}):safari.self.tab.dispatchMessage("setSetting",{field:"version",value:255});$(".closeb").click(function(a){a.preventDefault();$("#changelog").hide()})}if(inThread&&board){title="/"+board+"/ - "+document.getElementsByTagName("blockquote")[0].innerHTML.replace(/\<.*?\>/g,"");document.title=title}$("<div />").attr("id","popup").appendTo("body");if(settings.smartbar!="off"&&(settings.smartbar1!="off"&&!inThread||settings.smartbar2!="off"&&inThread)){b="<div style='margin-bottom: -4px'><input type='checkbox' id='autodown' /> <label style='cursor: pointer' for='autodown'>Preload images <span id='counter'>("+
totalImg+")</span></label></div><div style='margin-bottom: -10px'><input type='checkbox' id='autoexpand' class='checkoff' /> <label style='cursor: pointer' for='autoexpand'>Expand images</label></div>";a=document.createElement("div");a.id="navbar";a.setAttribute("class","reply navbar"+settings.smartbarpos);a.setAttribute("style","border-top-width: 1px !important;");var d;d=""+("<li id='crntBoard'><a href='/"+board+"' style='text-decoration: none;'>/"+board+"/</a></li>");if(settings.preloading1!="off"&&
!inThread||settings.preloading2!="off"&&inThread)d=d+("<li id='loadImages'>"+b+"</li>");settings.quickreply!="off"&&(settings.quickbutton2!="off"&&settings.quickreply2!="off"&&inThread?d=d+"<li class='quickreplybar'><span style='font-size: 15px'>&#8627;</span> <a id='navquickbutton' style='cursor: pointer'>Reply</a></li>":settings.quickbutton1!="off"&&(settings.quickreply1!="off"&&!inThread)&&(d=d+"<li class='quickreplybar'><span style='font-size: 15px'>&#8627;</span> <a id='navquickbutton' style='cursor: pointer'>New thread</a></li>"));
if(settings.jumpbuttons1!="off"&&!inThread||settings.jumpbuttons2!="off"&&inThread)d=d+"<li class='jump'><a href='javascript:window.scrollTo(0, 0);'>Top</a> &uarr; <a href='javascript:window.scrollTo(0, document.body.scrollHeight);'>Bottom</a> &darr;</li>";a.innerHTML="<div id='baritems'>"+d+"</div>";document.body.appendChild(a);if(settings.smartbarpos==2)a.style.marginLeft=a.offsetWidth/2*-1+"px";b=document.createElement("div");b.id="boardsMenu";b.setAttribute("class","reply");b.innerHTML=boardMenu;
if(settings.smartbarpos==1)b.style.left="0px";if(settings.smartbarpos==2){b.style.left="50%";b.style.marginLeft="-325px";a.style.marginLeft=a.offsetWidth/2*-1+"px"}if(settings.smartbarpos==3)b.style.right="0px";a.firstChild.firstChild.appendChild(b);if(settings.preloading1!="off"&&!inThread||settings.preloading2!="off"&&inThread){$("#autodown").change(function(){if($(this).attr("checked")){autodown=true;preloadImages()}else autodown=false});$("#autoexpand").change(function(){if($(this).attr("checked")){autoexpand=
true;expandAll()}else{autoexpand=false;$(".fileThumb").each(function(){var a=$(this).parent().attr("id");$(this).html("<img src='"+files[a][0]+"' />").find("img").css({width:files[a][4][0],height:files[a][4][1]});files[a][2]=false})}})}settings.quickreply!="off"&&(settings.quickbutton1!="off"&&!inThread||settings.quickbutton2!="off"&&inThread)&&$("#navquickbutton").click(function(a){var b=$("#quickrep");if(!showquickreply||resto||b.offset().top+b.height()<document.body.scrollTop||b.offset().top>document.body.scrollTop+
window.innerHeight){a.stopPropagation();b.show();showquickreply=true;positionReplybox(400,0,true);if(resto){document.getElementById("postform").com.value="";document.forms.post.elements.com.value="";$("#restofield").val("");$("#quicktitle").html("New thread");resto=false}}else{a.stopPropagation();hideQuickreply()}})}if(!title)title=document.title;if(settings.quickreply!="off"&&(settings.quickreply1!="off"&&!inThread||settings.quickreply2!="off"&&inThread)){document.getElementsByTagName("form");a=
$("form:first");$("<div />").html('<div id="quickreplydrag"><h4 id="quicktitle">'+(inThread?"Reply":"New thread")+'</h4><img src="'+img.close+'" id="quickreplyclose" /></div><form id="postform" action="'+a.attr("action")+'" target="quickreplyframe" method="post" enctype="multipart/form-data"><input type=\'hidden\' name=\'resto\' id=\'restofield\' />'+a.html().replace(/\<script(.*?)\>(.*?|(\n)*?)\<\/script\>/gi,"").replace(/(id=")/gi,"$1clone_")+'</form><iframe id="quickreplyframe" name="quickreplyframe"></iframe><div id="message"><img src="'+
img.load+'"> <span>Posting message...</span></div><div id="response"></div>').attr({id:"quickrep","class":"reply"}).appendTo("body").hide();$("#postform :submit").attr("id","submitbutton");$("#quickreplyclose").click(function(a){a.stopPropagation();hideQuickreply()});$("#quickreplydrag").mousedown(function(a){a.stopPropagation();a.originalEvent.preventDefault();window.mousePos=[a.pageX,a.pageY];window.quickReplyOffset=$("#quickrep").offset();dragging=true});$(document).mousemove(function(a){a.stopPropagation();
a.originalEvent.preventDefault();if(dragging){a=[a.pageX,a.pageY];$("#quickrep").css({top:quickReplyOffset.top+a[1]-mousePos[1],left:quickReplyOffset.left+a[0]-mousePos[0]})}}).mouseup(function(){dragging&&(dragging=false)}).scroll(function(){if($(window).scrollTop()+$(window).height()==$(document).height()&&settings.unread!="off"){unread=0;document.title=title}});$("#clone_recaptcha_reload, #recaptcha_reload").click(function(){$("#recaptcha_response_field").hide();recapreload=$("#clone_recaptcha_image > img").attr("src");
setTimeout("isRefreshed()",50)});if(settings.progress!="off"){a=$("#quickrep input[name=upfile]");a.attr("id","fileupload");$('<progress id="progress" max="100">').insertBefore(a)}$("#postform").submit(function(a){ext==1&&a.preventDefault();(ext==2||settings.progress=="off")&&$("#message").show();$("#recaptcha_response_field").hide();$("#recaptcha_reload").click();a=new FormData(document.getElementById("postform"));if(ext==1){if(document.getElementById("postform").elements.upfile.value&&settings.progress!=
"off"){$("#response, #fileupload").hide();$("#progress").show()}else{$("#response").hide();$("#message").show()}var b=new XMLHttpRequest;b.upload.addEventListener("progress",uploadProgress,false);b.open("POST",$("#postform").attr("action"));b.onreadystatechange=function(){b.readyState==4&&(b.status==200?processPostResponse(b.responseText):console.log("Error loading page\n"))};b.send(a)}})}$(window).focus(function(){windowfocus=true}).blur(function(){windowfocus=false});settings.threadupdating!="off"&&
inThread&&(refresher=setTimeout(function(){refreshThread()},refreshrate));settings.expansion!="off"&&!inThread&&$(".summary").each(function(){var a=$(this).html().match(/([^.]+\.)/),b=$("<img />").attr({src:img.exp,"class":"expand"});$(this).html(a[1]).prepend(b).click(function(){$(this).html("Fetching posts...");var a=$(this).parent().attr("id").substr(1),b=protocol+"//boards.4chan.org/"+board+"/res/"+a;ext==1?chrome.extension.sendRequest({link:b,threadid:a},extensionResponses):safari.self.tab.dispatchMessage("expand",
{link:b,threadid:a})})});zoomify();if(settings.autopreloading!="off"&&(!inThread&&settings.autopreloading1!="off"||inThread&&settings.autopreloading2!="off")){$("#autodown").attr("checked","true");autodown=true;preloadImages()}if(settings.autopreloading!="off"&&(!inThread&&settings.autoexpand1!="off"||inThread&&settings.autoexpand2!="off")){$("#autoexpand").attr("checked","true");autoexpand=true;expandAll()}}
function isRefreshed(){if($("#recaptcha_image > img").attr("src")!=recapreload){$("#clone_recaptcha_image").html($("#recaptcha_image").html());$("#clone_recaptcha_challenge_field").val($("#recaptcha_challenge_field").val());$("#recaptcha_response_field").show();$("#clone_recaptcha_response_field").val("").focus()}else setTimeout("isRefreshed()",50)}function uploadProgress(a){settings.progress!="off"&&$("#progress").val(Math.round(a.loaded/a.total*100))}
function zoomify(a,b){a=a?a+" ":"";$(a+".fileThumb").each(function(){var a=$(this).parent().attr("id"),b=$(this).find("img"),d=b.attr("src"),c=$(this).attr("href"),e=$(this).parent().html().match(/, ([0-9]+)x([0-9]+),/);if(e){e=[e[1],e[2]];images[1]++;files[a]=[settings.replaceSRC!="off"?c:d,c,false,false,[b.width(),b.height()],e];$(this).mouseover(function(a){if(settings.hoverable!="off"){var b=$(this).parent().attr("id");if(!files[b][2]){var d=$(this).find("img"),c=$(this).attr("href");$(this).is(".imgspoiler")&&
(files[b][6]=true);$("#popup").html("<img id='temp"+b+"' src='"+c+"' />").show().find("img").error(function(){$("#popup").html("<img src='http://sys.4chan.org/error/404/rid.php' />")}).load(function(){var a=$(this).attr("id").substr(4);settings.replaceSRC!="off"&&!files[a][6]&&d.attr("src",c);if(!files[a][3]){files[a][3]=true;images[0]++;$("#counter").html("("+images[0]+"/"+images[1]+")")}});positionPopup([a.pageX,a.pageY],files[b][5]);showpopup=true}}}).mousemove(function(a){showpopup&&positionPopup([a.pageX,
a.pageY])}).mouseout(function(){if(showpopup){showpopup=false;$("#popup").hide()}}).click(function(a){if(settings.expandable!="off"){var b=$(this).parent().attr("id");if(showpopup){showpopup=false;$("#popup").hide()}if(!a.ctrlKey&&!a.metaKey&&!(a.altKey||a.which==2)){dblclick||a.preventDefault();if(files[b]){if(files[b][2]){var d=$(this).parents(".thread"),c=d.next(),a=c.offset().top-d.offset().top;$(this).html("<img src='"+files[b][0]+"' />").find("img").css({width:files[b][4][0],height:files[b][4][1]});
var e=$(this).offset().top;if(window.pageYOffset>e){d=c.offset().top-d.offset().top;pos2=$(window).scrollTop()-(a-d);window.scrollTo(window.pageXOffset,Math.max(e-24,pos2))}}else{$(this).html("<img src='"+files[b][1]+"' class='expanded' />").find("img").load(function(){var a=$(this).parent().parent().attr("id");if(!files[a][3]){files[a][3]=true;images[0]++;$("#counter").html("("+images[0]+"/"+images[1]+")")}});if(settings.expandtype==1){a=$(window).width();e=$(this).offset().left;a=Math.min(a-e-25,
files[b][5][0]);e=files[b][5][1]*a/files[b][5][0];if(settings.ignoreheight=="off"&&e>$(window).height()-50){e=$(window).height()-50;a=files[b][5][0]*e/files[b][5][1]}$(this).find("img").css({width:a,height:e})}else if(settings.expandtype==2){c=files[b][5][0];d=files[b][5][1];a=Math.min(settings.expandw,files[b][5][0]);e=Math.min(settings.expandh,files[b][5][1]);c=d*a/c;c>settings.expandh?a=a*e/d:e=c;$(this).find("img").css({width:a,height:e})}}files[b][2]=files[b][2]?false:true}if(settings.dblclickable!=
"off"){dblclick=true;setTimeout(function(){dblclick=false},400)}}}})}});$("#counter").html("("+images[0]+"/"+images[1]+")");if(settings.embeds!="off"&&settings.embeds1!="off"&&!inThread||settings.embeds2!="off"&&inThread)for(var d,c=xpath((a==""?".":"id('"+a.substr(1,a.length-2)+"')")+"//text()[ancestor::blockquote]"),e=0;e<c.snapshotLength;e++){d=c.snapshotItem(e);d!=null&&linkActivation(d)}settings.quotes!="off"&&$(a+".quotelink").each(function(){if(!$(this).hasClass("button")){if(settings.backlinking!=
"off"&&(settings.backlinking1!="off"&&!inThread||settings.backlinking2!="off"&&inThread)&&!b){var a=inThread?inThread[1]:$(this).parents(".thread").attr("id").substr(1),d=$(this).parent().parent().attr("id").substr(1),c=$(this).attr("href").match(/[0-9]+$/);if(d&&c){c=c[0].toString();backlinks[c]?backlinks[c][backlinks[c].length]=[d,a]:backlinks[c]=[[d,a]]}}if(settings.backlinking!="off"&&b){d=$(this).parent().parent().attr("id").substr(1);c=$(this).attr("href").match(/[0-9]+$/);if(d&&c){var c=c[0].toString(),
e='<span id="bli_'+c+"_"+d+'"><a href="/'+board+"/res/"+a+"#p"+d+'" class="quotelink bcklink">&gt;&gt;'+d+"</a></span>";if(backlinks[c]){backlinks[c][backlinks[c].length]=[d,a];$("#bl_"+c).append(e)}else{backlinks[c]=[[d,a]];$("#p"+c).append('<div class="backlinkHr"><hr></div><div id="bl_'+c+'" class="backlink"><strong>Replies:</strong> '+e+"</div>")}$("#bl_"+c+" .bcklink").mouseover(function(){var a=$(this).html().match(/[0-9]+/);$("#p"+a).addClass("highlight");$("#popup").html("<div class='quickpreview "+
$("#p"+a[0]).attr("class")+"'>"+$("#p"+a[0]).html()+"</div>").show();positionQuote($(this))}).mouseout(function(){var a=$(this).html().match(/[0-9]+/);$("#p"+a).removeClass("highlight");$("#popup").html("").hide();showpopup=false})}}$(this).mouseover(function(a){a.preventDefaault;showpopup=true;var b=$("#popup");if(inThread){var d=$(".thread").attr("id").substr(1),c=$(this).attr("href").match(/(\/[a-z0-9]+)?(\/?res\/)?([0-9]+)#p([0-9]+)/),e=c[3],f=c[4]?c[4]:c[3];if(c[1]){d=c[1]?c[1]:board;c=protocol+
"//boards.4chan.org/"+d+"/res/"+c[3];b.html("<img src='"+img.load+"' />").show();positionPopup([a.pageX,a.pageY]);curextquote=$(this);ext==1?chrome.extension.sendRequest({link:c,quote:f},extensionResponses):safari.self.tab.dispatchMessage("externalQuote",{link:c,quote:f})}else{e=c[3];f=c[4];if(e==d){b.html("<div class='quickpreview "+$("#p"+f).attr("class")+"'>"+$("#p"+f).html()+"</div>").show();positionQuote($(this))}else showpopup=false}}else{c=$(this).attr("href").match(/(\/[a-z0-9]+)?(\/?res\/)?([0-9]+)#p([0-9]+)/);
f=c[4]?c[4]:c[3];if($("#p"+f).length>0){b.html("<div class='quickpreview "+$("#p"+f).attr("class")+"'>"+$("#p"+f).html()+"</div>").show();positionQuote($(this))}else{d=c[1]?c[1]:board;c=protocol+"//boards.4chan.org/"+d+"/res/"+c[3];b.html("<img src='"+img.load+"' />").show();positionPopup([a.pageX,a.pageY]);curextquote=$(this);ext==1?chrome.extension.sendRequest({link:c,quote:f},extensionResponses):safari.self.tab.dispatchMessage("externalQuote",{link:c,quote:f})}}}).mouseout(function(){$("#popup").hide();
curextquote=showpopup=false})}});if(settings.backlinking!="off"&&(settings.backlinking1!="off"&&!inThread||settings.backlinking2!="off"&&inThread)&&!b){for(backlink in backlinks){d={};for(var c="",g=2,e=0;e<backlinks[backlink].length;e++)if(!d[backlinks[backlink][e][0]]){d[backlinks[backlink][e][0]]=true;c=c+('<span id="bli_'+backlink+"_"+backlinks[backlink][e][0]+'"><a href="/'+board+"/res/"+backlinks[backlink][e][1]+"#p"+backlinks[backlink][e][0]+'" class="quotelink bcklink">&gt;&gt;'+backlinks[backlink][e][0]+
"</a></span>"+(g>0&&g%11==0?"<br />":""));g++}$("#p"+backlink).append('<div class="backlinkHr"><hr></div><div id="bl_'+backlink+'" class="backlink"><strong>Replies:</strong> '+c+"</div>")}$(".bcklink").mouseover(function(){var a=$(this).html().match(/[0-9]+/);$("#p"+a).addClass("highlight");$("#popup").html("<div class='quickpreview "+$("#p"+a[0]).attr("class")+"'>"+$("#p"+a[0]).html()+"</div>").show();positionQuote($(this))}).mouseout(function(){var a=$(this).html().match(/[0-9]+/);$("#p"+a).removeClass("highlight");
$("#popup").html("").hide();showpopup=false});inThread||(backlinks={})}settings.quickreply!="off"&&(settings.quickreply1!="off"&&!inThread||settings.quickreply2!="off"&&inThread)&&$(a+".postNum a:nth-child(2)").click(function(a){var b=$(this).html();if(showquickreply&&curquote==b){inThread||a.preventDefault();hideQuickreply()}else{curquote=b;if(!inThread){a.preventDefault();(a=$(this).attr("href").match(/res\/([0-9]+)#q[0-9]+/))?resto=a[1]:$(this).parent().find("a:first").attr("href").match(/res\/([0-9]+)#q[0-9]+/);
$("#restofield").val(resto);$("#quicktitle").html("Reply")}a=document.getElementById("postform").com;a.value=a.value.substr(0,a.selectionStart)+">>"+b+"\n"+a.value.substr(a.selectionStart);replybox=$("#quickrep");if(!showquickreply){replybox.show();showquickreply=true}b=$(this).offset();positionReplybox(b.left,b.top,false)}})}
function positionReplybox(a,b,d){var c=$("#quickrep"),e=window.innerWidth;c.css("left",Math.max(a+50,e-(e-(a+50))/2-c.width()/4*3));d?c.css("top",document.body.scrollTop+window.innerHeight/2-c.height()/2):c.css("top",Math.min(b,document.body.scrollHeight-c.height()-150))}
function positionPopup(a,b){var d=$("#popup");if(b){c=b[0];e=b[1]}else var c=d.width(),e=d.height()-3;var g=$(window).width(),f=$(window).height();if(e>f-40)var h=f-40,c=c*h/e,e=h;if(c>g-40-a[0]){g=g-40-a[0];e=e*g/c;c=g}d.css({top:Math.max(window.pageYOffset+10,Math.min(a[1]-e/2,window.pageYOffset+f-(30+e))),left:a[0]+10});b&&$("#popup").children(":first").css({width:c,height:e})}
function positionQuote(a){var b=$("#popup"),d=b.height(),a=a.offset(),d=a.top-d-10;d<window.pageYOffset&&(d=a.top+16);b.css({top:d,left:a.left})}function posted(a){alert(a);$("#message").hide()}
function hideQuickreply(){$("#quickrep").hide();curquote=showquickreply=false;document.getElementById("postform").com.value="";document.forms.post.elements.com.value="";$("#fileupload").replaceWith('<input id="fileupload" name="upfile" type="file">');if(!inThread){$("#restofield").val("");$("#quicktitle").html("New thread")}}
function refreshThread(){ext==1?chrome.extension.sendRequest({link:window.location.href,returnmsg:"newposts"},extensionResponses):safari.self.tab.dispatchMessage("refreshthread",{link:window.location.href})}
function findNewPosts(a){if(a==404){$(".board").append("<b>Thread 404'd after this.</b><hr />");speedyrefresh=false;clearTimeout(refresher)}else{console.log("Refreshing thread...");if(!threadposts){threadposts={};var b=document.getElementById("delform").innerHTML;for(reg=RegExp('postContainer [a-z]+" id="pc([0-9]+)',"gi");(result=reg.exec(b))!==null;)threadposts[result[1]]=true}var a=$(a),d=[];$(".postContainer",a).each(function(){cur=$(this).attr("id").substr(2);if(!threadposts[cur]){threadposts[cur]=
true;d.push([cur,$(this)])}});if(d.length>0){a=false;settings.leanbackmode!="off"&&($(window).scrollTop()+$(window).height()==$(document).height()&&windowfocus)&&(a=true);for(i=0;i<d.length;i++){$(".thread").append(d[i][1]);zoomify("#pc"+d[i][0],true);autodown&&preloadImages("#pc"+d[i][0]);autoexpand&&expandAll("#pc"+d[i][0])}if(a){if(settings.leanbackreplies!="off"){var b=$(document).height()-($(window).scrollTop()+$(window).height()),c=$("#quickrep").offset().top;$("#quickrep").animate({top:c+b},
250)}$("html, body").animate({scrollTop:$(document).height()},Math.min(500,refreshrate))}if(!a&&settings.unread!="off"){unread=unread+d.length;document.title="("+unread+") "+title}speedyrefresh=false;clearTimeout(refresher);refresher=setTimeout(function(){refreshThread()},refreshrate)}clearTimeout(refresher);refresher=setTimeout(function(){refreshThread()},speedyrefresh?200:refreshrate)}}
function expandThread(a,b){if(b==404)$("#t"+a+" .summary").html("Thread 404'd");else{var d=$("#pi"+a).find(".postNum").html();$("#t"+a).html($(".thread",b).html().replace(/"([0-9]+#p[0-9]+)/gi,'"res/$1'));$("#pi"+a).find(".postNum").html(d);zoomify("#t"+a);autodown&&preloadImages("#t"+a);autoexpand&&expandAll("#t"+a);$("#p"+a+", #t"+a).append('<span class="summary desktop retr" id="ret'+a+'"><img src="'+img.min+'" class="expand">Retract thread</span>').find(".retr").click(function(){showquickreply&&
hideQuickreply();var b=$(this).attr("id").substr(3);$("#t"+b+" > .replyContainer, #t"+b+" .retr, #t"+b+" .repl").hide();$("#exp"+b).show();window.scrollTo(0,Math.min($("#t"+a).offset().top,window.pageYOffset))});$("#t"+a).append('<span class="summary desktop repl" id="rep'+a+'"><img src="'+img.replyicon+'" class="expand">Quick reply</span>').find(".repl").click(function(){if(showquickreply)hideQuickreply();else{resto=$(this).attr("id").substr(3);$("#restofield").val(resto);$("#quicktitle").html("Reply");
replybox=$("#quickrep");if(!showquickreply){replybox.show();showquickreply=true}$(this).offset();positionReplybox(400,0,true)}});$("#t"+a).append('<span class="summary desktop exp" id="exp'+a+'"><img src="'+img.exp+'" class="expand">Expand thread</span>').find(".exp").click(function(){var a=$(this).attr("id").substr(3);$("#t"+a+" > .replyContainer, #t"+a+" .retr, #t"+a+" .repl").show();$(this).hide()}).hide()}}
function externalQuote(a,b){if(showpopup&&curextquote){var d=$("#popup"),c=$("#p"+a,b);b==404?d.html("Thread 404'd").show():d.html("<div class='quickpreview "+c.attr("class")+"'>"+c.html()+"</div>").show();positionQuote(curextquote)}curextquote=false}
function preloadImages(a){$((a?a+" ":"")+".fileThumb").each(function(){var a=$(this).parent().attr("id"),d=$(this).find("img");d.attr("src");var c=$(this).attr("href");d.attr("alt")!="File deleted."&&files[a]&&(files[a][2]||(settings.replaceSRC!="off"&&!$(this).is(".imgspoiler")?d.attr("src",c).load(function(){var a=$(this).parent().parent().attr("id");if(!files[a][3]){files[a][3]=true;images[0]++;$("#counter").html("("+images[0]+"/"+images[1]+")")}}):$("<img />").attr({src:c,id:"temp"+a}).load(function(){var a=
$(this).attr("id").substr(4);if(!files[a][3]){files[a][3]=true;images[0]++;$("#counter").html("("+images[0]+"/"+images[1]+")")}})))})}
function expandAll(a){$((a?a+" ":"")+".fileThumb").each(function(){var a=$(this).parent().attr("id");if(files[a]){files[a][3]||(files[a][3]=true);images[0]=images[1];$("#counter").html("("+images[0]+"/"+images[1]+")");if(files[a][5]&&!$(this).is(".imgspoiler")){$(this).html("<img src='"+files[a][1]+"' class='expanded' />");files[a][2]=true;if(settings.expandtype==1){var d=$(window).width(),c=$(this).offset().left,d=Math.min(d-c-25,files[a][5][0]),c=files[a][5][1]*d/files[a][5][0];if(settings.ignoreheight==
"off"&&c>$(window).height()-50){c=$(window).height()-50;d=files[a][5][0]*c/files[a][5][1]}$(this).find("img").css({width:d,height:c})}else if(settings.expandtype==2){var e=files[a][5][0],g=files[a][5][1],d=Math.min(settings.expandw,files[a][5][0]),c=Math.min(settings.expandh,files[a][5][1]),a=g*d/e;a>settings.expandh?d=d*c/g:c=a;$(this).find("img").css({width:d,height:c})}}}})}
function linkActivation(a){for(var b,d,c=a.textContent,e=null,g=0,f={};(d=links.exec(c))!==null;)if(!f[d[0]]){f[d[0]]=true;null===e&&(e=document.createElement("span"));b=d[0].replace(/\.*$/,"");e.appendChild(document.createTextNode(c.substring(g,d.index)));if(!b.match(/\.4chan\.org/i)){b=(youtube=b.match(/youtube\.com\/watch\?.*?v=([a-z0-9-_#!]+)/i))&&(settings.youtube1!="off"&&!inThread||settings.youtube2!="off"&&inThread)?'<iframe class="youtube-player" type="text/html" width="640" height="385" src="http://www.youtube.com/embed/'+
youtube[1]+'?wmode=opaque" frameborder="0"></iframe><br /><a href="'+b+'" target="_blank">'+b+"</a>":(vocaroo=b.match(/vocaroo\.com\/(i\/|\?media=)([a-z0-9]+)/i))&&(settings.vocaroo1!="off"&&!inThread||settings.vocaroo2!="off"&&inThread)?'<object type="application/x-shockwave-flash" style="width: 148px; height: 44px" data="http://vocaroo.com/player.swf?playMediaID='+vocaroo[2]+'&server=m1.vocaroo.com&autoplay=0""><param name="movie" value="http://vocaroo.com/player.swf?playMediaID='+vocaroo[2]+'&server=m1.vocaroo.com&autoplay=0"></object><br /><a href="'+
b+'" target="_blank">'+b+"</a>":(soundcloud=b.match(/((www\.)?soundcloud\.com\/([a-z0-9-_]+\/?)+)/i))&&(settings.soundcloud1!="off"&&!inThread||settings.soundcloud2!="off"&&inThread)?'<object height="81" width="400"><param name="movie" value="http://player.soundcloud.com/player.swf?url=http://'+soundcloud[1]+'&amp;g=bb"></param><param name="allowscriptaccess" value="always"></param><embed allowscriptaccess="always" height="81" src="http://player.soundcloud.com/player.swf?url=http://'+soundcloud[1]+
'&amp;g=bb" type="application/x-shockwave-flash" width="400"></embed></object><br /><a href="http://'+soundcloud[1]+'" target="_blank">http://'+soundcloud[1]+"</a>":b.indexOf("@")>-1&&(settings.email1!="off"&&!inThread||settings.email2!="off"&&inThread)?"<a href='mailto:"+b+"'>"+b+"</a>":settings.links1!="off"&&!inThread||settings.links2!="off"&&inThread&&b.indexOf("@")<0?"<a href='"+(b.match(/^http/i)?b:"http://"+b)+"' target='_blank'>"+b+"</a>":b;e.innerHTML=b;g=d.index+d[0].length}}if(e){e.appendChild(document.createTextNode(c.substring(g,
c.length)));try{a.parentNode.replaceChild(e,a)}catch(h){console.error(h)}}}function xpath(a){return document.evaluate(a,document,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null)};