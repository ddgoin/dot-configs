(function(b){var S,I,J,K,T,U,L,V,W,X,Y,v,Z,$,aa,ba,ca,da,M;function pa(){var a=window.innerHeight,d=document.compatMode;if(d||!b.support.boxModel)a="CSS1Compat"==d?document.documentElement.clientHeight:document.body.clientHeight;return a}function qa(a,d){var c=setInterval(function(){var j=pa(),l=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop;b(a).each(function(){var a=b(this),e=a.offset().top,g=a.height(),i=a.data("inview")||!1;l>e+g||l+j<e?i&&a.data("inview",
!1):l<e+g&&!i&&(console.log(l,e,g,e+g),a.data("inview",!0),clearInterval(c),d())})},750)}function ea(a){b(S,e).html(a);b(I,e).css("visibility","visible");setTimeout(ra,5E3)}function ra(){b(I,e).css("visibility","hidden")}function q(){chrome.extension.sendRequest({action:"track",track:arguments})}function fa(a){chrome.extension.sendRequest({action:"trackPageview",track:a})}function sa(){var a=b,d='<div data-eid="'+r+'" class="'+J+' anydo-tour"><h2>'+c("gmail_tour_title")+"</h2>",n;n="<p>"+c("gmail_tour").replace(/\n{2,}/g,
"</p><p>").replace(/\n/g,"<br>")+"</p>";w=a(d+n+"<footer></footer></div>");w.insertAfter(s);a=ga()+2;w.css("left",a+"px").show();s.addClass("anydo-tour-on");N=!1}function O(a){if(3===a.nodeType)return a.textContent;if("BR"==a.nodeName)return"\n";var d=b.map(a.childNodes,O),a={block:"\n","inline-block":"\n","table-row":"\n","table-cell":"\t"}[getComputedStyle(a).display]||"";return d.join("")+a}function ta(){var a=/#.*\/([0-9a-f]{16})$/.exec(window.location.hash);return a?a[1]:null}function ua(a){return Date.parse(a.replace("at ",
""))}function ha(){return Sha1.hash(""+b(K,e).attr("title")+">:<"+o().originalTitle)}function va(){if(null!==ta()){for(var a=b(T,e),d=o().originalTitle,c=b(U).text(),a=a.map(function(a,e){var j=b(L,e),l=b(V,e),i=b(K,e),f=b(W,e),g=O(f[0]),h=b('img[src="images/cleardot.gif"]',f);if(0<h.length){var g=Sha1.hash(g),k=b('<div style="display:none">'+g+"</div>");h.after(k);f=O(f[0]);g=f.substr(0,f.search(g));k.remove()}l=l.map(function(a,d){var c=b(d);return{email:c.attr("email"),name:c.text()}});k=j.attr("email");
return k.toLowerCase()===c.toLowerCase()?null:{sender:{name:j.text(),email:k},recipients:l,date:ua(i.attr("title")),subject:d,body:g}}),j=ha(),l=JSON.parse(localStorage.getItem(j)||"{}"),f=[],h=0;h<a.length;h++)for(var g=b.task_extractor.extract_tasks(a[h]),i=0;i<g.length;i++)l.hasOwnProperty(g[i][0])?console.log(j+" already seen: "+g[i]):(f.push(g[i]),b.post("http://afternoon-earth-1266.herokuapp.com/raw_email_analytics",{suggestion:g[i][0],original:g[i][1],conversation:j}));f.conversation=j;return f}}
function wa(a){var d=b(X,e).last(),n='<div class="gA gt ac5 anydo-anybar" data-eid="'+r+'"><div class="gB"><div class="iq"><table class="cf FVrZGe"><tbody>            <tr><td class="amq"><img src="'+x("images/anydo-profile.png")+'" class="ajn bofPge"></td>            <td class="amr"><strong>What\'s Next?</strong><input class="bar-input" type="text" value="<% text %>" data-placeholder="<% followup_example %>" placeholder="<% followup_followUpPlaceholder %>">            <div class="suggestion-controls">                <span class="suggestion-container">                <a href="#" class="suggestion-add suggestion-date-category category-today" data-category="TODAY">'+
c("x_date_today")+'</a>                    <div class="reminder-choices-popup">                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="09:00:00">'+c("x_9am")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="12:00:00">'+c("x_12pm")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="20:00:00">'+c("x_8pm")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder custom">'+
c("date_custom")+'</a>                    </div>                    <div class="reminder-choices-popup customReminderPicker">                    <iframe class="calendarFrame"></iframe>                    <a class="anydo-setCustomReminder suggestion-add" href="#">SET</a>                    </div>                </span>                <span class="suggestion-container">                <a href="#" class="suggestion-add suggestion-date-category" data-category="TOMORROW">'+c("x_date_tomorrow")+'</a>                    <div class="reminder-choices-popup">                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="09:00:00">'+
c("x_9am")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="12:00:00">'+c("x_12pm")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="20:00:00">'+c("x_8pm")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder custom">'+c("x_date_custom")+'</a>                    </div>                </span>                <span class="suggestion-container">                <a href="#" class="suggestion-add suggestion-date-category" data-category="UPCOMING">'+
c("x_later")+'</a>                    <div class="reminder-choices-popup">                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="7">'+c("x_date_1_week")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="14">'+c("x_date_2_weeks")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="30">'+c("x_date_1_month")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder custom">'+
c("x_date_custom")+"</a>                    </div>                </span>            </div>            </td></tr></tbody></table></div></div></div>",j=!1;0==a.length&&(a[0]=[""],j=!0);var l=0,k=document.location.href,h=o(),h=h.followUpName?c("x_followup_with",h.followUpName):c("x_followup_on",h.originalTitle),g=c("x_followup_placeholder",h),i=b(n.replace("<% text %>",a[l][0]).replace("<% followup_example %>",h).replace("<% followup_followUpPlaceholder %>",g));d.before(i);b(".bar-input",i).css({"border-style":"solid",
"border-color":"#ABADB3","border-width":"1px"});qa(d,function(){setTimeout(function(){j||b(".bar-input",i).animate({"background-color":"rgba(251, 255, 161, 1.0)"},300).animate({"background-color":"rgba(251, 255, 161, 0.0)"},300)},100)});P=b(".customReminderPicker .calendarFrame",e);P.attr("src",B+"#inAnybar=true");N&&sa();i.on("click",".suggestion-add",function(d){d.preventDefault();d=b(d.target);b(this).parents(".reminder-choices-popup").addClass("invisible");var c=i.find(".bar-input").val()||i.find(".bar-input").data("placeholder"),
n={title:c,linkUrl:k,conversation:a.conversation};console.log(a,n);var j="DATE_CATEGORY_TODAY";d.data("category")&&(j="DATE_CATEGORY_"+d.data("category"));if(d.hasClass("suggestion-reminder")){j=d.parents(".suggestion-container").children(".suggestion-date-category").data("category");f=y[j]();d.data("reminder")&&ia(d.data("reminder"),f);j=f;n.alert=t}if(d.hasClass("custom")){console.log(d,d.parent());P.attr("src",B.replace(/(#.+)?$/,"#"+f+"&inAnybar=true"));b(".customReminderPicker",e).insertAfter(d.parent()).addClass("visible")}else{var g=
"";console.log("add task: "+c);if(l<a.length){var h=a[l][0];console.log("original suggestion: "+h);n.originalSuggestion=h;var h=ha(),m=JSON.parse(localStorage.getItem(h)||"{}");m[c]=true;localStorage.setItem(h,JSON.stringify(m));l++;l<a.length&&(g=a[l][0])}i.find(".bar-input").val(g);q("Gmail","Actionbar Task Added");if(d.hasClass("anydo-setCustomReminder")){j=f;n.alert=t}console.log("adding task with details",n,j);ja({type:"gmailAddTask",data:n,dateCategory:j})}});var m=d.parent().children().first();
d.parent().on("click",function(){setTimeout(function(){var d=m.is(":visible");i.toggle(d)},300)})}function ja(a){chrome.extension.sendMessage(a,function(d){console.log("got response",d);d.success?ea(c("task_added",['<a href="javascript:;" class="anydo-open-popup ad SL7K4c" data-eid="'+r+'" tabindex="0">Any.DO</a>'])):"loggedOut"===d.errorReason&&ea(c("error_must_login_first"))})}function z(a,d){ja({type:"gmailAddTask",data:{title:a.inputTitle,linkUrl:a.url,alert:t},dateCategory:d})}function C(a){return"string"!==
typeof a?a:(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function o(){var a={originalTitle:C(b(Y).text()),inputTitle:p?C(p.val()):null,fromName:b(v)?C(b(v).attr("name").split(" ")[0]):null,fromEmail:b(v)?C(b(v).attr("email")):null,url:document.location.href},d=b(L,e).map(function(d,a){return b(a).attr("name")}).filter(function(d,a){return a!==b(Z,e).text()}),c=d.length;a.followUpName=c?d[c-1].split(" ")[0]:null;a.taskTitle=a.originalTitle+" (from "+
a.fromName+")";return a}function D(a,d){d=d||new Date;d.setSeconds(0);d.setDate(d.getDate()+a);d.setMinutes(5*parseInt(d.getMinutes()/5));return+d+""}function ga(){var a=b.isWindow,d;b.isWindow=function(){return!0};d=s.position().left;b.isWindow=a;return d}function xa(){if(!b($).is(":visible")){var a=b(aa,e);if(void 0!==a.data("anydo_marker"))console.log("found existing marker, exiting");else{a.data("anydo_marker","anydo");var d=b(E+":visible",e),n=b(ba,e);chrome.extension.sendMessage({type:"isGmailActive"},
function(a){if(a.gmail){if(d.length||!n.length)return;var f=n.find(ca),o="<div data-eid='"+r+"' class='"+(da+" anydo-button")+"' data-tooltip='"+c("add_this_thread")+"' style='padding-left: 16px; padding-right: 16px;'>\t\t                                <div aria-haspopup='true' style='-webkit-user-select: none; margin-bottom:0px;margin-top:-2px; outline: none;' role='button' class='J-J5-Ji W6eDmd L3 J-Zh-I J-J5-Ji Bq L3' tabindex='0'> \t\t                                    <img class='f tk3N6e-I-J3' src='"+
x("icons/anydo-gmail-local.png")+"' style='vertical-align: -3px; height: 13px;'/> <span class='anydo-button-text'>"+c("remind_me")+"</span> <div class='G-asx T-I-J3 J-J5-Ji'>&nbsp;</div></div>\t\t                                </div>\t\t                           ",h="<div data-eid='"+r+"' class='"+(J+" anydo-menu")+"' style='display: none; position: absolute; min-width: 278px; -webkit-user-select: none; overflow: hidden;'>                            <div class='menuInnerContainer' style='position: relative; left: 0;'>                            <div class='SK AX' style='-webkit-user-select: none;'>                                <h2>"+
c("add_to_my_anydo")+"</h2>                                 <span style='margin-left: 15px; color: #8e8e8e; font-size: 15px;'>"+c("gmail_task_title_label")+"</span> <div class='J-M-JJ asg' style='border: none; display: inline-block; padding: 0; margin: 11px 0 17px; width: 80%; max-width: 225px;'>                                     <input class='anydo-input-title' style='color: #000; font-style: italic; font-size: 14px; padding: 6px 7px; border: 1px solid #ddd; width: 92%;'>                                 </div>                                 <div class='J-Kh' style='-webkit-user-select: none; margin: -3px 4px 0; padding-top: 3px; border-top-color: #e1e1e1;'></div>                                <% items %>                            </div>                            <div class='reminderPanel' style='display: none;'><iframe class='calendarFrame'></iframe>                                <a class='anydo-back' href='#'>"+
c("back")+"</a>                                <a class='anydo-setReminder' href='#'>"+c("set")+"</a>                            </div>                            </div>                        </div>";s=b(o);var g="";b.each(ka,function(a,d){g+="<div class='J-N anydo-item <% classNames %>' role='menuitem' data-id='<% id %>' style='-webkit-user-select: none; <% css %>'><% text %><span class='remind'><% reminderLinks %></span></div>".replace(/<% text %>/,d.text).replace(/<% id %>/,a).replace(/<% reminderLinks %>/,
d.reminderLinks||"").replace(/<% classNames %>/,d.classNames||"").replace(/<% css %>/,d.css||"")});h=h.replace(/<% items %>/,g);k=b(h);f.filter(":last").append(s.add(k));u=b(m+" .reminderPanel",e);F=b(m+" .menuInnerContainer",e);Q=u.find(".calendarFrame");p=b(m+" .anydo-input-title",e);R=p.parent();Q.attr("src",B);fa("/gmail-thread")}else b(e).find(E+","+m+","+la).remove();a.gmailNext&&(a=va(),wa(a),0==a.length?console.log("no tasks detected!"):q("Gmail","Suggested",""+a.length))})}}}function ma(){w&&
(w.remove(),s.removeClass("anydo-tour-on"))}function A(){k&&(s.removeClass(M),k.removeClass("open").hide(),k.css({width:G,height:H}),F.css("left",0),u.hide(),f=null,t={type:"NONE"})}function ia(a,d){if(-1<a.toString().indexOf(":"))f=new Date(+d),f.setHours.apply(f,a.split(":").map(parseFloat)),f=+f;else{var b=864E5*+a,d=new Date;d.setHours(9);d.setMinutes(0);d.setSeconds(0);f=+d+b}t={customTime:0,offset:0,type:"OFFSET"}}function na(a){b(a).each(function(a,c){c=b(c);c.data("reminder").split(":")[0]<=
(new Date).getHours()?c.addClass("pastTime"):c.removeClass("pastTime")})}var N=!1,x=chrome.extension.getURL,c=chrome.i18n.getMessage,e=b(document),oa=b("body",e),s,k,G,H,u,F,w,f,t,p,R,Q,B=x("calendar.html"),P,r=c("@@extension_id"),E=".anydo-button[data-eid="+r+"]",m=".anydo-menu[data-eid="+r+"]",la=".anydo-tour[data-eid="+r+"]";b('<link rel="stylesheet">').attr("href",x("css/gmail.css?v=")+Math.random()).appendTo(oa);b('<link rel="stylesheet">').attr("href",x("css/pfdindisplaypro-inline.css")).appendTo(oa);
chrome.extension.sendMessage({type:"gmailInit"},function(a){N=a.tour});ba=".iH[gh=mtb]";Y=".hP:visible";v=".gD";da="T-I J-J5-Ji ar7 nf T-I-ax7 L3";M="T-I-Kq";J="J-M jQjAxd";I=".b8.UC";S=".b8.UC .vh";ca=".G-Ni.J-J5-Ji";T=".h7:visible";aa=".h7.ie";L=".gD";V=".g2";K=".g3";W=".ii.gt.adP.adO";X=".gA.gt";U="[aria-owns=gbd4]";Z="#gbmpn";$="#loading";var y={TODAY:function(){return D(0)},TOMORROW:function(){return D(1)},UPCOMING:function(){return D(2)},SOMEDAY:function(){return D(8)}},ka=[{text:c("date_today"),
category:"DATE_CATEGORY_TODAY",reminderLinks:'<a href="#" data-reminder="09:00:00">'+c("9am")+'</a> <a href="#" data-reminder="12:00:00">'+c("12pm")+'</a> <a href="#" data-reminder="16:00:00">'+c("4pm")+'</a> <a href="#" data-reminder="20:00:00">'+c("8pm")+'</a> <a href="#" class="custom">'+c("date_custom")+"</a>",getDate:y.TODAY,action:function(){q("Gmail","Today");z(o(),"DATE_CATEGORY_TODAY")}},{text:c("date_tomorrow"),category:"DATE_CATEGORY_TOMORROW",reminderLinks:'<a href="#" data-reminder="09:00:00">'+
c("9am")+'</a> <a href="#" data-reminder="12:00:00">'+c("12pm")+'</a> <a href="#" data-reminder="16:00:00">'+c("4pm")+'</a> <a href="#" data-reminder="20:00:00">'+c("8pm")+'</a> <a href="#" class="custom">'+c("date_custom")+"</a>",getDate:y.TOMORROW,action:function(){q("Gmail","Tomorrow");z(o(),"DATE_CATEGORY_TOMORROW")}},{text:c("date_custom"),classNames:"anydo-custom",category:"DATE_CATEGORY_TODAY",getDate:y.TODAY,action:function(){q("Gmail","Custom")}},{text:c("date_someday"),category:"DATE_CATEGORY_SOMEDAY",
getDate:y.SOMEDAY,action:function(){q("Gmail","Someday");z(o(),"DATE_CATEGORY_SOMEDAY")}}];(function(){var a=b(e);a.on("click",E+","+la,function(a){a.stopPropagation();ma();k.is(".open")?A():k&&(s.addClass(M),a=o(),p.val(a.taskTitle),a=ga(),k.addClass("open").css("left",a+"px").show(),p[0].selectionStart=p[0].selectionEnd=0,fa("/gmail-menu"))});a.on("click",m+", .customReminderPicker",function(a){a.stopPropagation()});a.on("click",function(a){A();ma();0==b(a.target).parents(".suggestion-controls").length&&
b(".customReminderPicker",e).removeClass("visible")});a.on("hover",E,function(){b(this).toggleClass("T-I-JW")});a.on("hover",m+" [role=menuitem]",function(){b(this).toggleClass("J-N-JT")});a.on("mouseenter",m+" [role=menuitem]",function(){0==b(this).data("id")&&na(b(this).find("[data-reminder]"))});a.on("mouseenter",".suggestion-date-category",function(){b(this).next(".reminder-choices-popup").removeClass("invisible");b(this).hasClass("category-today")&&na(b(this).next().find("[data-reminder]"))});
a.on("click",".anydo-open-popup[data-eid="+r+"]",function(){chrome.extension.sendRequest({action:"popupWindow"})});a.on("click",m+" .anydo-item",function(a){var c=ka[b(this).data("id")],e=c.action;if(""==b.trim(p.val()))p.focus().parent().addClass("invalid");else if(b(a.target).is("[data-reminder]"))a.stopPropagation(),a.preventDefault(),e=b(a.target).attr("data-reminder"),ia(e,c.getDate()),z(o(),f),q("Gmail",c.text,b(a.target).text()),c.keepMenuOpen||A();else if(b(a.target).hasClass("custom")&&q("Gmail",
c.text,"Custom"),b(a.target).hasClass("anydo-custom")&&q("Gmail","Custom"),b(a.target).hasClass("anydo-custom")||b(a.target).hasClass("custom")){u.show();f=c.category;c=c.getDate();Q.attr("src",B.replace(/(#.+)?$/,"#"+c));var c=u.width(),e=u.height(),l=-1*c-10;G=k.width();H=k.height();k.css({width:G,height:H}).animate({width:c,height:e},100);F.css("left",0).animate({left:l},200);chrome.extension.sendRequest({action:"trackPageview",track:"/calendarWindow"})}else c.keepMenuOpen||A(),"function"===typeof e&&
e.apply(this,arguments)});a.on("keyup",m+" .anydo-input-title",function(){""==b.trim(p.val())?R.addClass("invalid"):R.removeClass("invalid")});setInterval(xa,300);chrome.extension.onMessage.addListener(function(a){a&&"gmailCalendarPick"==a.type&&(t=a.alert,f=a.dateTime)});a.on("click",m+" .anydo-setReminder",function(a){a.preventDefault();z(o(),f);A()});a.on("click",m+" .anydo-back",function(a){a.preventDefault();F.animate({left:0},200);k.animate({width:G,height:H},200)})})()})(jQuery);