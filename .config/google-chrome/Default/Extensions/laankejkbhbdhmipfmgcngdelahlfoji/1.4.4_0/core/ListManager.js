define(["require","core/Logger","core/vendor/jquery.min","core/DomainParser"],function(e,t,n,r){var s=function(){return e("core/StayFocusd")},o={blacklist:{},whitelist:{},log:function(e,n,r,i){},init:function(){this.loadBlacklist(),this.loadWhitelist(),this.isSyncDisabled()||this.addSyncChangeListener()},isSyncDisabled:function(){return this.getLocal("disableSync")==="true"},addSyncChangeListener:function(){var e=this;chrome.storage.onChanged.addListener(function(t,n){e.loadBlacklist(),e.loadWhitelist()})},loadBlacklist:function(e){if(this.isSyncDisabled()){var t=this.getLocal("blacklist");this.onBlacklistLoaded(JSON.parse(t)),typeof e=="function"&&e()}else{var n=this;this.getSynced("blacklist",function(t){n.onBlacklistLoaded(t),typeof e=="function"&&e()})}},onBlacklistLoaded:function(e){if(typeof e!="object"||e===null)e={};typeof e[""]=="object"&&(delete e[""],this.blacklist=e,this.saveBlacklist()),this.blacklist=sort(e)},saveBlacklist:function(){this.isSyncDisabled()?this.setLocal("blacklist",JSON.stringify(sort(this.blacklist))):this.setSynced({blacklist:sort(this.blacklist)})},addToBlacklist:function(e){return e.indexOf("stayfocusd")>=0?(alert(chrome.i18n.getMessage("cannotBlockStayFocusd")),!1):(this.removeFromWhitelist(e),this.blacklist[e]={},this.blacklist=this.cleanUpList(e,this.blacklist),this.saveBlacklist(),s().checkURL(),!0)},removeFromBlacklist:function(e){return this.isBlacklisted(e)&&s().isMaxTimeAllowedExceeded()?(alert(chrome.i18n.getMessage("cannotRemoveSiteOnceTimeIsUp")),!1):(delete this.blacklist[e],this.saveBlacklist(),s().checkURL(),!0)},clearBlacklist:function(){if(s().isMaxTimeAllowedExceeded())return alert(chrome.i18n.getMessage("cannotClearBlockedSitesOnceTimeIsUp")),!1;this.blacklist={},this.setSynced({blacklist:this.blacklist})},getBlacklistedDomains:function(){var e=[];for(var t in this.blacklist)this.blacklist.hasOwnProperty(t)&&e.push(t);return e},loadWhitelist:function(e){if(this.isSyncDisabled()){var t=this.getLocal("whitelist");this.onWhitelistLoaded(JSON.parse(t)),typeof e=="function"&&e()}else{var n=this;this.getSynced("whitelist",function(t){n.onWhitelistLoaded(t),typeof e=="function"&&e()})}},onWhitelistLoaded:function(e){if(typeof e!="object"||e===null)e={};typeof e[""]=="object"&&(delete e[""],this.whitelist=e,this.saveWhitelist()),this.whitelist=sort(e)},saveWhitelist:function(){this.isSyncDisabled()?this.setLocal("whitelist",JSON.stringify(sort(this.whitelist))):this.setSynced({whitelist:sort(this.whitelist)})},addToWhitelist:function(e){if(s().isMaxTimeAllowedExceeded()){if(this.isBlacklisted(e))return alert(chrome.i18n.getMessage("cannotAllowBlockedSiteOnceTimeIsUp")),!1;if(e.indexOf("*")>-1)return alert(chrome.i18n.getMessage("cannotAllowSitesUsingWildcardsOnceTimeIsUp")),!1}return NuclearOption.isActive()?(alert(chrome.i18n.getMessage("cannotAddAllowedSitesDuringNuclearOption")),!1):(this.removeFromBlacklist(e),this.whitelist[e]={},this.whitelist=this.cleanUpList(e,this.whitelist),this.saveWhitelist(),s().checkURL(),!0)},removeFromWhitelist:function(e){return delete this.whitelist[e],this.saveWhitelist(),s().checkURL(),!0},clearWhitelist:function(){if(NuclearOption.isActive())return alert(chrome.i18n.getMessage("cannotClearAllowedSitesDuringNuclearOption")),!1;this.whitelist={},this.setSynced({whitelist:this.whitelist})},getWhitelistedDomains:function(){var e=[];for(var t in this.whitelist)this.whitelist.hasOwnProperty(t)&&e.push(t);return e},isBlacklisted:function(e){return this.isListed(e,"black")},isWhitelisted:function(e){return this.isListed(e,"white")},isListed:function(e,t){return this.getMatchFromList(e,t)!==!1},getMatchFromList:function(e,t){var n=t=="white"?this.whitelist:this.blacklist;for(var i in n)if(n.hasOwnProperty(i)){var s=/^[a-z0-9]+$/i;if(s.test(i)&&typeof n[i]=="function")continue;if(r.isMoreGeneralURL(i,e))return i;if(i.indexOf("*")===0&&r.matchesWildcard(i,e))return i}return!1},cleanUpList:function(e,t){var n={};for(var i in t)if(t.hasOwnProperty(i)){var s=!1;for(var o in n)n.hasOwnProperty(o)&&(i==o||r.isMoreGeneralURL(o,i))&&(s=!0);if(s===!0)continue;r.isMoreGeneralURL(e,i)?n[e]={}:i!=undefined&&i!=null&&i!=""&&(n[i]={})}return n},mergeLocalWithSynced:function(e){var t=this.getLocal("blacklist"),n=this.getLocal("whitelist"),r=JSON.parse(t)||{},i=JSON.parse(n)||{},s=this;this.getSynced("blacklist",function(t){var n=t||{};for(var i in r)r.hasOwnProperty(i)&&(n[i]=r[i]);s.setSynced({blacklist:n}),s.loadBlacklist(e)}),this.getSynced("whitelist",function(t){var n=t||{};for(var r in i)i.hasOwnProperty(r)&&(n[r]=i[r]);s.setSynced({whitelist:n}),s.loadWhitelist(e)})},setSynced:function(e){chrome.storage.sync.set(e,function(){});for(var t in e)e.hasOwnProperty(t)&&this.setLocal("sync_"+t,JSON.stringify(e[t]))},getSynced:function(e,t){var n=this;return chrome.storage.sync.get(e,function(r){if(typeof r=="undefined"){var i=n.getLocal("sync_"+e);r={},r[e]=JSON.parse(i)||{}}t(r[e])})},removeSynced:function(e){return this.removeLocal("sync_"+e),chrome.storage.sync.remove(e,function(){})},setLocal:function(e,t){localStorage.setItem(e,t)},getLocal:function(e){return localStorage.getItem(e)},removeLocal:function(e){return localStorage.removeItem(e)}};return o});var sort=function(e){var t=[],n={};for(var r in e)e.hasOwnProperty(r)&&t.push(r);t.sort();for(var i=0;i<t.length;i++){var s=t[i];n[s]=e[s]}return n};