define(["core/Logger","core/ListManager","core/DomainParser","core/NuclearOption","core/Notification","core/ReferrerMonitor","core/DateUtils"],function(e,t,n,r,i,s,o){var a={maxTimeAllowed:10,firstInstallAllowance:60,elapsedTime:0,interval:1,timer:null,maxTimeAllowedExceeded:!1,badgeVisible:!1,apiURL:"http://www.stayfocusd.com",redirectURL:"http://www.stayfocusd.com",currentURL:null,version:null,selectedTabID:null,active:null,popupPort:null,infoBarShown:{BLOCKED_BY_REFERRER:{}},log:function(t,n,r,i){},init:function(){var e=this;this.isFirstInstall()&&this.setFirstInstallAllowance(),this.isNewDay()&&this.resetElapsedTime(),t.init(),r.init(),i.init(),this.maxTimeAllowed=this.getMaxTimeAllowed(),this.elapsedTime=this.getElapsedTime(),this.maxTimeAllowedExceeded=this.isMaxTimeAllowedExceeded();var n=this.getActiveDays();this.setActiveDays(n),chrome.runtime.onConnect.addListener(function(t){t.name==="popup"&&e.onPopupConnected(t)}),chrome.tabs.getSelected(null,function(t){e.onTabStateChange(t)}),chrome.tabs.onSelectionChanged.addListener(function(t,n){chrome.tabs.getSelected(null,function(t){e.onTabStateChange(t)})}),chrome.tabs.onUpdated.addListener(function(t,n){chrome.tabs.getSelected(null,function(t){e.onTabStateChange(t)})}),chrome.tabs.onRemoved.addListener(function(t,n){chrome.tabs.getSelected(null,function(t){t===undefined&&clearInterval(e.timer)})}),chrome.windows.onRemoved.addListener(function(t){clearInterval(e.timer)}),chrome.windows.onFocusChanged.addListener(function(t,n){chrome.tabs.getSelected(null,function(t){e.onTabStateChange(t)}),chrome.windows.getLastFocused(function(t){t!==undefined&&chrome.tabs.getAllInWindow(t.id,function(t){for(var n in t)t.hasOwnProperty(n)&&t[n].selected&&e.checkURL(t[n].url)})})}),chrome.windows.onCreated.addListener(function(t,n){chrome.tabs.getAllInWindow(t.id,function(t){for(var n in t)t.hasOwnProperty(n)&&t[n].selected&&e.checkURL(t[n].url)})}),chrome.extension.onRequest.addListener(function(t,n,r){var i=e.handleContentScriptRequest(t,n);i!==null&&r(i)})},onPopupConnected:function(e){this.popupPort=e;var t=this;e.onDisconnect.addListener(function(e){t.popupPort=null}),this.postTimerUpdatedMessage()},postTimerUpdatedMessage:function(){this.popupPort&&this.popupPort.postMessage({message:"StayFocusd.timer.updated",payload:{displayTimer:this.getDisplayTimer()}})},handleContentScriptRequest:function(e,t){var n={},r=this;switch(e.message){case"hideInfoBar":n={infoBarHidden:r.setLocal("hideInfoBar","true")};break;case"isInfoBarHidden":n={infoBarHidden:r.getLocal("hideInfoBar")==="true"};break;case"saveOutgoingLink":n={success:r.setLocal("outgoingLink",e.outgoingLink)};break;default:n=null}return n},onTabStateChange:function(e){if(typeof e=="undefined")return!1;this.currentURL=e.url,this.selectedTabID=e.id,this.checkURL(e.url);if(!this.isBlockable(e.url)&&!t.isWhitelisted(e.url)&&this.isOutgoingLinksOptionActive()){var n=this.getLocal("outgoingLink"),r=this;s.isBlockable(e.url,n)||chrome.tabs.sendRequest(e.id,{message:"getReferrer"},function(e){e=e||{},e.referrer=typeof e.referrer=="undefined"?"":e.referrer,r.checkURL(e.referrer,!0)})}},checkURL:function(e,n){this.isNewDay()&&this.resetElapsedTime(),e=e==undefined?this.currentURL:e;var i=null,o=this;clearInterval(this.timer);var u=this.getLocal("outgoingLink");this.isBlockable(e,u)?(i=r.isActive()?"common/img/eye_19x19_nuclear.png":"common/img/eye_19x19_red.png",chrome.tabs.getSelected(null,function(e){e!==undefined&&(chrome.browserAction.setIcon({tabId:e.id,path:i}),chrome.tabs.sendRequest(e.id,{message:"saveOutgoingLink",target:"ReferrerMonitor"}))}),this.isKillable()?this.killPage():(this.timer=setInterval(this.tick.bind(this),this.interval*1e3),(!this.isBlockable(e)&&s.isBlockable(e,u)||n)&&chrome.tabs.getSelected(null,function(e){e!==undefined&&o.hasInfoBarBeenShown(e.url,"BLOCKED_BY_REFERRER")===!1&&o.showInfoBar(e,"BLOCKED_BY_REFERRER")}))):t.isWhitelisted(e)?chrome.tabs.getSelected(null,function(e){e!==undefined&&chrome.browserAction.setIcon({tabId:e.id,path:"common/img/eye_19x19_green.png"})}):(i=r.isActive()?"common/img/eye_19x19_nuclear.png":"common/img/eye_19x19_blue.png",chrome.tabs.getSelected(null,function(e){e!==undefined&&chrome.browserAction.setIcon({tabId:e.id,path:i})}))},isOutgoingLinksOptionActive:function(){var e=this.getLocal("countdownForOutgoingLinks");return e==""||e==undefined||e==null?!0:e=="true"},hasInfoBarBeenShown:function(e,t){var n=encodeURIComponent(e);return this.infoBarShown[t][n]===!0},showInfoBar:function(e,t){var n=this;this.getLocal("hideInfoBar")!=="true"&&chrome.tabs.sendRequest(e.id,{message:"show",msgType:t,target:"InfoBar"},function(r){var i=encodeURIComponent(e.url);n.infoBarShown[t][i]=!0})},isKillable:function(){return this.isMaxTimeAllowedExceeded()||r.isActive()},isProtectedURL:function(e){return e===null||e==undefined||e.length==0?!1:e.indexOf(this.redirectURL)===0?!0:e.indexOf("paypal")>=0?!0:e.indexOf("chrome")>=0&&e.indexOf("chrome")<e.indexOf("://")&&(e.indexOf("sf")>-1||e.indexOf("devtools")>-1)?!0:!1},isBlockable:function(e,i){if(this.isProtectedURL(e))return!1;if(e==null||e==undefined||e=="")return!1;if(this.isActive()===!1)return!1;var o=t.isBlacklisted(e),u=t.isWhitelisted(e),a=r.isBlockable(o,u);if(a)return!0;if(o&&!u)return!0;if(o&&u){var f=t.getMatchFromList(e,"black"),l=t.getMatchFromList(e,"white");return f===e&&l!==e?!0:f!==e&&l===e?!1:n.isMoreGeneralURL(l,f)}return u||r.isActive()&&!a?!1:this.isOutgoingLinksOptionActive()&&typeof i=="string"&&i.length>0?s.isBlockable(e,i):!1},isNewDay:function(){var e=!1,t=new Date,n=t.getTime(),r=this.getLocal("resetTimestamp"),i=this.getResetTime();if(r==undefined||r==null||r==""){var s=i.split(":"),o=parseInt(s[0],10),u=parseInt(s[1],10),a=new Date(t.toDateString()+" "+o+":"+u);r=a.getTime(),this.updateResetTimestamp(i)}return r=parseInt(r),n=parseInt(n),n>r&&(e=!0,this.updateResetTimestamp(i)),e},getElapsedTime:function(){var e=this.getLocal("elapsedTime");if(isNaN(e)||e==undefined)e=0,this.resetElapsedTime();return e},resetElapsedTime:function(){var e=this.getDateString();this.setLocal("lastReset",e),this.setLocal("elapsedTime",0),this.maxTimeAllowedExceeded=!1,this.elapsedTime=0},updateBadge:function(){var e=this.getTotalSecondsRemaining(),t=!1,n=[],r=this;e<=30?(t=!0,n=[200,10,10,100]):e<=60&&(t=!0,n=[255,245,0,100]),t===!0?r.isBlockable(this.currentURL)?(chrome.browserAction.setBadgeBackgroundColor({tabId:r.selectedTabID,color:n}),chrome.browserAction.setBadgeText({tabId:r.selectedTabID,text:e.toString()}),this.badgeVisible=!0):chrome.browserAction.setBadgeText({tabId:r.selectedTabID,text:""}):r.badgeVisible===!0&&(chrome.browserAction.setBadgeText({tabId:r.selectedTabID,text:""}),this.badgeVisible=!1)},killPage:function(){var e=this;return clearInterval(this.timer),chrome.windows.getLastFocused(function(t){t!==undefined&&chrome.tabs.getAllInWindow(t.id,function(t){for(var n in t)t.hasOwnProperty(n)&&t[n].selected&&(e.isMaxTimeAllowedExceeded()||r.isActive()&&!r.hasSmartBomb()?t[n].pinned===!0?chrome.tabs.sendRequest(t[n].id,{message:"killPage",redirectURL:e.redirectURL}):chrome.tabs.update(t[n].id,{url:e.redirectURL+"?background"}):r.isActive()&&r.hasSmartBomb()&&chrome.tabs.sendRequest(t[n].id,{message:"smartBomb",smartBomb:r.getSmartBomb(),target:"SmartBomb"}))})}),!1},getMaxTimeAllowed:function(){var e=this.getLocal("maxTimeAllowed");if(e==undefined||e==null||e=="")e=this.maxTimeAllowed;return e=parseInt(e,10),e},setMaxTimeAllowed:function(e){if(!e)return alert(chrome.i18n.getMessage("cannotSetTimeToZeroOrLess")),!1;e=parseInt(e,10);var t=this.getTotalSecondsRemaining(),n=!0;if(this.isMaxTimeAllowedExceeded())return alert(chrome.i18n.getMessage("cannotChangeTimeOnceTimeIsUp")),!1;if(e>=1440)return alert(chrome.i18n.getMessage("cannotSetMoreThan1440Mins")),!1;if(e<=0)return alert(chrome.i18n.getMessage("cannotSetTimeToZeroOrLess")),!1;if(this.elapsedTime/60>=e){alert(chrome.i18n.getMessage("allSitesBlockedImmediately"));if(n===!1)return!1}if(e>this.maxTimeAllowed){if(this.isProductivityBypassActive())return alert(chrome.i18n.getMessage("completeChallengeBeforeIncreasingTime")),!1;t<180?(n=confirm(chrome.i18n.getMessage("lessThanThreeMins")),n===!0&&(n=confirm(chrome.i18n.getMessage("lessThanThreeMins2"))),n===!0&&(n=confirm(chrome.i18n.getMessage("lessThanThreeMins3"))),n===!0&&(n=confirm(chrome.i18n.getMessage("lessThanThreeMins4"))),n===!0&&(n=confirm(chrome.i18n.getMessage("lessThanThreeMins5"))),n===!0&&(n=confirm(chrome.i18n.getMessage("lessThanThreeMins6"))),n===!0&&(n=confirm(chrome.i18n.getMessage("lessThanThreeMins7"))),n===!0&&(n=confirm(chrome.i18n.getMessage("lessThanThreeMins8"))),n===!0&&(alert(chrome.i18n.getMessage("tellingYourMom")),window.open("http://www.sas.calpoly.edu/asc/ssl/procrastination.html"))):(n=confirm(chrome.i18n.getMessage("maybeYouShouldReconsider")),n===!0&&(n=confirm(chrome.i18n.getMessage("onlyHurtingYourself"))),n===!0&&alert(chrome.i18n.getMessage("meow")))}if(n===!0){var r=chrome.i18n.getMessage("settingsUpdated");e<this.maxTimeAllowed&&(r=chrome.i18n.getMessage("givingLessTime")+"\n\n"+r),this.maxTimeAllowed=e,this.setLocal("maxTimeAllowed",e),alert(r)}return n},isMaxTimeAllowedExceeded:function(){return this.maxTimeAllowedExceeded===!0?!0:this.elapsedTime/60>this.maxTimeAllowed?(this.maxTimeAllowedExceeded=!0,!0):!1},getTotalSecondsRemaining:function(){var e=this.maxTimeAllowed*60-this.elapsedTime;return e>=0?Math.floor(e):0},getDisplayTimer:function(){var e=this.getTotalSecondsRemaining();if(e==0)return"00:00:00";var t=Math.floor(e/3600),n=Math.floor((e-t*3600)/60),r=e-(t*3600+n*60);return t=o.toTwoDigits(t),n=o.toTwoDigits(n),r=o.toTwoDigits(r),t+":"+n+":"+r},getDateString:function(){var e=new Date,t=e.getMonth()+1,n=e.getDate(),r=e.getFullYear();return r+"-"+t+"-"+n},setActiveDays:function(e){var t=null;e.length===0?t="none":t=e.join("|"),this.setLocal("activeDays",t)},getActiveDays:function(){var e=this.getLocal("activeDays");return e=="none"?[]:e==undefined||e==null||e.length===0?[0,1,2,3,4,5,6]:e.split("|")},isActiveDay:function(){var e=new Date,t=e.getDay(),n=this.getActiveDays();return n==undefined||n==null||n.length===0?!1:n.inArray(t)},setActiveHours:function(e,t){this.setLocal("activeHours",e+"|"+t)},getActiveHours:function(){var e=!1,t=!1,n=this.getActiveHoursQueue();if(n!==!1){var r=new Date,i=r.getTime();if(i>n.timestamp||this.isFirstInstallAllowanceActive())e=n.startTime,t=n.endTime,this.setActiveHours(e,t),this.clearActiveHoursQueue()}if(e===!1&&t===!1){var s=this.getLocal("activeHours");if(s==undefined||s==null||s=="")this.setActiveHours("00:00","23:59"),s=this.getLocal("activeHours");var o=s.split("|");e=o[0],t=o[1]}var u=e.split(":"),a=t.split(":");return{startTime:e,endTime:t,startHour:u[0],startMin:u[1],startHourInt:parseInt(u[0],10),startMinInt:parseInt(u[1],10),endHour:a[0],endMin:a[1],endHourInt:parseInt(a[0],10),endMinInt:parseInt(a[1],10)}},isActiveHour:function(){var e=this.getActiveHours(),t=new Date,n=t.getHours(),r=t.getMinutes();return this.isStartTimeLater(e)===!0?this.isBetween(n,r,e.startHourInt,e.startMinInt,23,59)||this.isBetween(n,r,0,0,e.endHourInt,e.endMinInt):this.isBetween(n,r,e.startHourInt,e.startMinInt,e.endHourInt,e.endMinInt)},isBetween:function(e,t,n,r,i,s){return e>n&&e<i?!0:e==n&&e==i?t>=r&&t<=s:e==n&&t>=r?!0:e==i&&t<=s?!0:!1},isStartTimeLater:function(e){return e.startHourInt==e.endHourInt&&e.startMinInt>=e.endMinInt?!0:e.startHourInt>e.endHourInt?!0:!1},setActiveHoursQueue:function(e,t){var n=new Date,r=n.getTime()+o.hoursToMilliseconds(24),i=r+"|"+e+"|"+t;this.setLocal("activeHoursQueue",i)},getActiveHoursQueue:function(){var e=this.getLocal("activeHoursQueue");if(e==undefined||e==null||e=="")return!1;var t=e.split("|"),n={};return n.timestamp=t[0],n.startTime=t[1],n.endTime=t[2],n},clearActiveHoursQueue:function(){this.removeLocal("activeHoursQueue")},isActive:function(){return r.isActive()===!0?!0:this.isActiveDay()===!0&&this.isActiveHour()===!0},updateResetTimestamp:function(e){var t=e.split(":"),n=parseInt(t[0],10),r=parseInt(t[1],10),i=new Date((new Date).toDateString()+" "+n+":"+r),s=i.getTime()+864e5;this.setLocal("resetTimestamp",s)},setResetTime:function(e){this.setLocal("resetTime",e)},getResetTime:function(){var e=this.getLocal("resetTime"),t=this.getResetTimeQueue();if(t!==!1){var n=new Date,r=n.getTime();if(r>t.timestamp||this.isFirstInstallAllowanceActive())e=t.resetTime,this.setResetTime(e),this.clearResetTimeQueue(),this.updateResetTimestamp(e)}if(e==undefined||e==null||e=="")this.setResetTime("00:00"),e=this.getLocal("resetTime"),this.updateResetTimestamp(e);return e},setResetTimeQueue:function(e){var t=new Date,n=t.getTime()+o.hoursToMilliseconds(24),r=n+"|"+e;this.setLocal("resetTimeQueue",r)},getResetTimeQueue:function(){var e=this.getLocal("resetTimeQueue");if(e==undefined||e==null||e=="")return!1;var t=e.split("|"),n={};return n.timestamp=t[0],n.resetTime=t[1],n},clearResetTimeQueue:function(){this.removeLocal("resetTimeQueue")},setProductivityBypass:function(){this.setLocal("productivityBypass","true")},clearProductivityBypass:function(){this.removeLocal("productivityBypass")},isProductivityBypassActive:function(){return this.getLocal("productivityBypass")=="true"},isFirstInstall:function(){return typeof this.getLocal("firstInstallDate")!="string"},isActivityMonitorDisabled:function(){return this.getLocal("disableActivityMonitor")==="true"},isUpdatePopupDisabled:function(){return this.getLocal("disableUpdatePopup")==="true"},setFirstInstallAllowance:function(){var e=new Date;this.setLocal("firstInstallDate",e.toDateString()),e.setMinutes(e.getMinutes()+this.firstInstallAllowance),this.setLocal("firstInstallAllowanceExpiration",e.getTime())},isFirstInstallAllowanceActive:function(){var e=this.getLocal("firstInstallAllowanceExpiration"),t=new Date;return e>t.getTime()},setLocal:function(e,t){localStorage.setItem(e,t)},getLocal:function(e){return localStorage.getItem(e)},removeLocal:function(e){return localStorage.removeItem(e)},localizeHTML:function(e){var t=e.getElementsByTagName("*");for(var n=0;n<t.length;n++)t[n].dataset&&t[n].dataset.i18n&&(t[n].innerHTML=chrome.i18n.getMessage(t[n].dataset.i18n))},tick:function(){this.isNewDay()&&this.resetElapsedTime(),this.elapsedTime=parseInt(this.elapsedTime,10)+this.interval;var e=this.getTotalSecondsRemaining();return this.postTimerUpdatedMessage(),i.isset(e)&&i.show("block"),this.isMaxTimeAllowedExceeded()?(this.killPage(),!1):(this.updateBadge(),this.setLocal("elapsedTime",this.elapsedTime),!0)}};return window.Logger=e,window.StayFocusd=a,window.NuclearOption=r,window.ListManager=t,window.Notification=i,window.DateUtils=o,a}),Array.prototype.removeByValue=function(e){this.indexOf(e)>=0&&this.splice(this.indexOf(e),1)},Array.prototype.inArray=function(e){for(var t in this)if(this.hasOwnProperty(t)&&this[t]==e)return!0;return!1};