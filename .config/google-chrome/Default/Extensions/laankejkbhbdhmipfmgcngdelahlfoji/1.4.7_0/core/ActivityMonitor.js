define(["core/Logger","core/vendor/jquery.min","core/vendor/Brightline.min","core/StayFocusd"],function(e,t,n,r){var s={DEBUG:!1,timer:null,interval:10,elapsedTime:0,maxInactiveTime:300,isOverlayActive:!1,isBlockable:!1,currentTabID:null,currentURL:null,isBlockerHTMLInjected:!1,log:function(t,n,r,i){},initContentScript:function(){this.DEBUG&&(this.interval=1,this.maxInactiveTime=3);var e=this;chrome.extension.sendRequest({message:"isBlockable"},function(n){e.isBlockable=n.isBlockable&&!n.isDisabled,t("body").keydown(function(){e.isOverlayActive===!0&&e.hideOverlay()}),e.isBlockable===!0&&(e.startTimer(),e.bindTimerReset("body"),t("iframe").each(function(){e.bindTimerReset(t(this).contents().find("body"))}))})},bindTimerReset:function(e){var n=this;e&&(t(e).mousedown(function(){n.resetTimer()}),t(e).mousemove(function(){n.resetTimer()}),t(e).keypress(function(){n.resetTimer()}))},handleContentScriptRequest:function(e,t){var n={};switch(e.message){case"isBlockable":t.tab=t.tab||{},n={isBlockable:r.isBlockable(t.tab.url),isDisabled:r.isActivityMonitorDisabled()};break;case"stopCountdown":n={countdownStopped:clearInterval(r.timer)};break;case"startCountdown":n={countdownStarted:null};break;default:n=null}return n},initBackgroundScript:function(){var e=this;chrome.tabs.onSelectionChanged.addListener(function(t,n){chrome.tabs.getSelected(null,function(t){t!==undefined&&(e.currentTabID!=null&&chrome.tabs.sendRequest(e.currentTabID,{message:"stopTimer"}),e.currentTabID=t.id,e.currentURL=t.url,chrome.tabs.sendRequest(e.currentTabID,{message:"resetTimer"}),chrome.tabs.sendRequest(e.currentTabID,{message:"hideOverlay"}),r.isBlockable(e.currentURL)&&!r.isActivityMonitorDisabled()&&chrome.tabs.sendRequest(e.currentTabID,{message:"startTimer"}))})}),chrome.extension.onRequest.addListener(function(t,n,r){var i=e.handleContentScriptRequest(t,n);i!==null&&r(i)})},handleBackgroundScriptRequest:function(e,t){var n={},r=this;switch(e.message){case"stopTimer":n={timerStopped:r.stopTimer()};break;case"startTimer":n={timerStarted:r.startTimer()};break;case"resetTimer":n={timerReset:r.resetTimer()};break;case"hideOverlay":n={overlayHidden:r.hideOverlay()};break;case"showOverlay":n={overlayShown:r.showOverlay(e.overlayType)};break;case"getReferrer":n={referrer:document.referrer};break;case"killPage":top.location.href=e.redirectURL+"?content",n={killed:!0};break;default:n=null}return n},startTimer:function(){clearInterval(this.timer),this.timer=setInterval(this.tick.bind(this),this.interval*1e3)},stopTimer:function(){clearInterval(this.timer)},resetTimer:function(){this.elapsedTime=0},isMaxInactiveTimeExceeded:function(){return this.elapsedTime>=this.maxInactiveTime},showOverlay:function(e){var n=this;if(!this.isBlockerHTMLInjected)return this.injectBlockerHTML(function(){n.showOverlay(e)}),null;t("embed").addClass("StayFocusd-hidden"),t("object").addClass("StayFocusd-hidden"),t("applet").addClass("StayFocusd-hidden"),t("#StayFocusd-still-there").css("top",t(window).scrollTop()+"px"),t("#StayFocusd-still-there").removeClass("inactive").addClass("active"),this.isOverlayActive=!0,this.stopTimer(),chrome.extension.sendRequest({message:"stopCountdown"})},hideOverlay:function(){this.isOverlayActive===!0&&(t("#StayFocusd-still-there").removeClass("active").addClass("inactive"),t("embed").removeClass("StayFocusd-hidden"),t("object").removeClass("StayFocusd-hidden"),t("applet").removeClass("StayFocusd-hidden"),this.isOverlayActive=!1,this.resetTimer(),this.startTimer(),chrome.extension.sendRequest({message:"startCountdown"}))},injectBlockerHTML:function(e){var r=this;this.loadTemplate("tpl/blocker.tpl",function(i){var s=new n(i);s.set("extensionURL",chrome.extension.getURL("/")),s.set("activityMonitorOverlayHeader",chrome.i18n.getMessage("activityMonitorOverlayHeader")),s.set("activityMonitorOverlayBody",chrome.i18n.getMessage("activityMonitorOverlayBody"));for(var o=1;o<=4;o++)s.set("activityMonitorOverlayLink"+o,chrome.i18n.getMessage("activityMonitorOverlayLink"+o));t("body").prepend(s.render()),t(document).on("click","#StayFocusd-unblock-link",function(){r.isOverlayActive===!0&&r.hideOverlay()}),r.isBlockerHTMLInjected=!0,typeof e=="function"&&e()})},loadTemplate:function(e,n){t.ajax({type:"GET",url:chrome.extension.getURL(e),dataType:"html",success:function(e){n(e)}})},tick:function(){this.elapsedTime+=this.interval,this.isMaxInactiveTimeExceeded()&&this.showOverlay("away")}};return s});